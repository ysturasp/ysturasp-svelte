<script lang="ts">
	import { onMount } from 'svelte';
	import { browser } from '$app/environment';
	import PageLayout from '$lib/components/layout/PageLayout.svelte';
	import Header from '$lib/components/layout/Header.svelte';
	import Footer from '$lib/components/layout/Footer.svelte';
	import NotificationsContainer from '$lib/components/notifications/NotificationsContainer.svelte';
	import ToiletSearchForm from './components/ToiletSearchForm.svelte';
	import ToiletResult from './components/ToiletResult.svelte';
	import type { ToiletSearchResult, Gender } from './types';
	import { findNearestToilet } from './utils';
	import { notifications } from '$lib/stores/notifications';

	let audience = '';
	let gender: Gender = 'male';
	let isLoading = false;
	let searchResult: ToiletSearchResult | null = null;
	let isInitialized = false;

	function handleSearch() {
		if (!audience.trim()) {
			searchResult = null;
			return;
		}

		try {
			isLoading = true;
			searchResult = findNearestToilet(audience.trim(), gender);
		} catch (error) {
			console.error('Error searching for toilet:', error);
			notifications.add('Ошибка при поиске туалета', 'error');
			searchResult = null;
		} finally {
			isLoading = false;
		}
	}

	onMount(() => {
		if (browser) {
			const savedAudience = localStorage.getItem('toiletSearch_audience');
			const savedGender = localStorage.getItem('toiletSearch_gender') as Gender | null;

			if (savedAudience) {
				audience = savedAudience;
			}
			if (savedGender && (savedGender === 'male' || savedGender === 'female')) {
				gender = savedGender;
			}
			isInitialized = true;
		}
	});

	$: {
		if (browser) {
			if (audience) {
				localStorage.setItem('toiletSearch_audience', audience);
			}
			if (gender) {
				localStorage.setItem('toiletSearch_gender', gender);
			}
		}
	}

	$: if (isInitialized && (audience || gender)) {
		handleSearch();
	}
</script>

<svelte:head>
	<title>Поиск туалетов в Г корпусе ЯГТУ | ysturasp</title>
	<meta
		name="description"
		content="Найдите ближайший туалет в Г корпусе ЯГТУ. Укажите аудиторию рядом с которой вы находитесь и мы найдем ближайший туалет."
	/>
	<meta
		name="keywords"
		content="туалеты ЯГТУ, поиск туалетов, Г корпус ЯГТУ, туалеты в корпусе, ysturasp"
	/>
	<meta property="og:title" content="Поиск туалетов в Г корпусе ЯГТУ | ysturasp" />
	<meta
		property="og:description"
		content="Найдите ближайший туалет в Г корпусе ЯГТУ. Укажите аудиторию рядом с которой вы находитесь и мы найдем ближайший туалет."
	/>
</svelte:head>

<PageLayout>
	<Header />

	<main class="container mx-auto mt-5 px-3 md:mt-7 md:px-0">
		<section class="mt-8 rounded-2xl bg-slate-800 p-4 sm:p-6">
			<div class="flex items-center gap-3">
				<div
					class="flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-xl bg-blue-600/20"
				>
					<svg
						class="h-6 w-6 text-blue-400"
						viewBox="0 0 100 100"
						xmlns="http://www.w3.org/2000/svg"
					>
						<path
							d="M0 0 C1.62035156 -0.02320312 1.62035156 -0.02320312 3.2734375 -0.046875 C4.31757812 -0.04171875 5.36171875 -0.0365625 6.4375 -0.03125 C7.38496094 -0.02673828 8.33242187 -0.02222656 9.30859375 -0.01757812 C12.8735762 0.66799542 14.46433534 1.91896453 17 4.5 C18.39379883 7.33740234 18.39379883 7.33740234 19.45703125 10.5859375 C19.84697266 11.76414062 20.23691406 12.94234375 20.63867188 14.15625 C21.02603516 15.3834375 21.41339844 16.610625 21.8125 17.875 C22.21919922 19.09445313 22.62589844 20.31390625 23.04492188 21.5703125 C26.45999061 32.08528044 26.45999061 32.08528044 26 37.5 C25.34 38.49 24.68 39.48 24 40.5 C23.01 40.5 22.02 40.5 21 40.5 C21.20625 41.263125 21.4125 42.02625 21.625 42.8125 C22 45.5 22 45.5 20 48.5 C17.6171875 48.79296875 17.6171875 48.79296875 14.875 48.6875 C13.96492188 48.66042969 13.05484375 48.63335937 12.1171875 48.60546875 C11.41851562 48.57066406 10.71984375 48.53585938 10 48.5 C10.01571045 49.57483643 10.01571045 49.57483643 10.03173828 50.67138672 C10.07321299 53.90588905 10.09929892 57.14033553 10.125 60.375 C10.14175781 61.50292969 10.15851563 62.63085938 10.17578125 63.79296875 C10.18544922 65.40751953 10.18544922 65.40751953 10.1953125 67.0546875 C10.21102295 68.54718018 10.21102295 68.54718018 10.22705078 70.06982422 C10 72.5 10 72.5 8 74.5 C5.29077199 74.69852102 2.70696821 74.77839477 0 74.75 C-1.10601562 74.76160156 -1.10601562 74.76160156 -2.234375 74.7734375 C-7.7466804 74.7533196 -7.7466804 74.7533196 -10 72.5 C-10.22705078 70.06982422 -10.22705078 70.06982422 -10.1953125 67.0546875 C-10.18886719 65.97832031 -10.18242188 64.90195313 -10.17578125 63.79296875 C-10.15902344 62.66503906 -10.14226563 61.53710938 -10.125 60.375 C-10.11597656 59.23933594 -10.10695313 58.10367188 -10.09765625 56.93359375 C-10.07403098 54.12218701 -10.04109013 51.31119702 -10 48.5 C-13.3 48.5 -16.6 48.5 -20 48.5 C-22.125 43.875 -22.125 43.875 -21 40.5 C-21.639375 40.37625 -22.27875 40.2525 -22.9375 40.125 C-23.618125 39.91875 -24.29875 39.7125 -25 39.5 C-27.86005735 33.77988531 -24.15334632 25.06197003 -22.3125 19.37304688 C-21.961875 18.32181641 -21.61125 17.27058594 -21.25 16.1875 C-20.91484375 15.11693359 -20.5796875 14.04636719 -20.234375 12.94335938 C-18.86968231 8.81568091 -17.59474957 5.29645728 -14.984375 1.80078125 C-10.09795878 -0.32903106 -5.26650124 -0.07541529 0 0 Z M-12 6.5 C-13.38007968 9.11831414 -13.38007968 9.11831414 -14.359375 12.27734375 C-14.94912109 14.00694336 -14.94912109 14.00694336 -15.55078125 15.77148438 C-15.94652344 16.98126953 -16.34226562 18.19105469 -16.75 19.4375 C-17.16121094 20.64341797 -17.57242188 21.84933594 -17.99609375 23.09179688 C-20.20141754 29.16848506 -20.20141754 29.16848506 -21 35.5 C-20.01 35.17 -19.02 34.84 -18 34.5 C-16.95402498 31.83939312 -16.09541416 29.29915161 -15.3125 26.5625 C-14.97508789 25.4497168 -14.97508789 25.4497168 -14.63085938 24.31445312 C-13.42450684 20.47418083 -13.42450684 20.47418083 -13 16.5 C-11.35 16.5 -9.7 16.5 -8 16.5 C-8.24234375 17.24161377 -8.4846875 17.98322754 -8.734375 18.74731445 C-9.82745543 22.10091674 -10.91380219 25.45666252 -12 28.8125 C-12.3815625 29.97974609 -12.763125 31.14699219 -13.15625 32.34960938 C-13.5171875 33.46787109 -13.878125 34.58613281 -14.25 35.73828125 C-14.58515625 36.76993408 -14.9203125 37.80158691 -15.265625 38.86450195 C-16.13421079 41.5256672 -16.13421079 41.5256672 -16 44.5 C-5.44 44.5 5.12 44.5 16 44.5 C14.45637096 37.3848874 14.45637096 37.3848874 12.4921875 30.46484375 C12.09580078 29.22250977 12.09580078 29.22250977 11.69140625 27.95507812 C11.42199219 27.12427734 11.15257812 26.29347656 10.875 25.4375 C10.59785156 24.57189453 10.32070312 23.70628906 10.03515625 22.81445312 C9.36031038 20.7084686 8.68188659 18.60371313 8 16.5 C9.65 16.5 11.3 16.5 13 16.5 C13.18175781 17.28503906 13.36351562 18.07007813 13.55078125 18.87890625 C14.94218388 24.69425571 16.42275046 30.10004859 19 35.5 C19.66 35.5 20.32 35.5 21 35.5 C19.63443759 28.84119319 17.83517256 22.48819565 15.625 16.0625 C15.33367187 15.16595703 15.04234375 14.26941406 14.7421875 13.34570312 C14.44828125 12.49041016 14.154375 11.63511719 13.8515625 10.75390625 C13.59197754 9.98377197 13.33239258 9.2136377 13.06494141 8.42016602 C11.71179717 5.98034956 10.6046745 5.42295161 8 4.5 C5.28921231 4.30798587 2.70647936 4.22058175 0 4.25 C-0.7115625 4.24226563 -1.423125 4.23453125 -2.15625 4.2265625 C-5.97449517 4.24080968 -8.8483256 4.28505986 -12 6.5 Z M-6 48.5 C-6 55.1 -6 61.7 -6 68.5 C-4.68 68.5 -3.36 68.5 -2 68.5 C-2 61.9 -2 55.3 -2 48.5 C-3.32 48.5 -4.64 48.5 -6 48.5 Z M2 48.5 C2 55.1 2 61.7 2 68.5 C3.32 68.5 4.64 68.5 6 68.5 C6 61.9 6 55.3 6 48.5 C4.68 48.5 3.36 48.5 2 48.5 Z"
							fill="currentColor"
							transform="translate(74,25.5)"
						/>
						<path
							d="M0 0 C1.28455078 -0.02900391 2.56910156 -0.05800781 3.89257812 -0.08789062 C5.13072266 -0.09626953 6.36886719 -0.10464844 7.64453125 -0.11328125 C9.3457312 -0.13515503 9.3457312 -0.13515503 11.08129883 -0.1574707 C14.85296461 0.41318532 16.48345982 1.67773916 19.1875 4.3125 C20.76417147 7.46584294 20.35047041 10.85012241 20.35546875 14.3125 C20.36046135 15.49972656 20.36046135 15.49972656 20.36555481 16.7109375 C20.3706204 18.38541075 20.37296325 20.0598941 20.37280273 21.734375 C20.37499127 24.30225135 20.39315609 26.86969959 20.41210938 29.4375 C20.41504291 31.06249853 20.41702797 32.6874991 20.41796875 34.3125 C20.42515427 35.08335938 20.43233978 35.85421875 20.43974304 36.6484375 C20.4163272 42.0836728 20.4163272 42.0836728 18.1875 44.3125 C15.0625 44.4375 15.0625 44.4375 12.1875 44.3125 C12.20321045 45.11469971 12.2189209 45.91689941 12.23510742 46.7434082 C12.29738583 50.37053404 12.33646864 53.99754749 12.375 57.625 C12.40013672 58.88763672 12.42527344 60.15027344 12.45117188 61.45117188 C12.46083984 62.65966797 12.47050781 63.86816406 12.48046875 65.11328125 C12.4961792 66.22872314 12.51188965 67.34416504 12.52807617 68.4934082 C12.1875 71.3125 12.1875 71.3125 10.92700195 73.17504883 C8.81177016 74.55818776 7.57884346 74.69909986 5.0625 74.7109375 C4.27359375 74.71480469 3.4846875 74.71867187 2.671875 74.72265625 C1.44210938 74.70525391 1.44210938 74.70525391 0.1875 74.6875 C-1.04226562 74.70490234 -1.04226562 74.70490234 -2.296875 74.72265625 C-3.08578125 74.71878906 -3.8746875 74.71492188 -4.6875 74.7109375 C-5.40679687 74.70755371 -6.12609375 74.70416992 -6.8671875 74.70068359 C-9.48389756 74.17852383 -10.31483836 73.5254887 -11.8125 71.3125 C-12.15307617 68.4934082 -12.15307617 68.4934082 -12.10546875 65.11328125 C-12.09580078 63.90478516 -12.08613281 62.69628906 -12.07617188 61.45117188 C-12.05103516 60.18853516 -12.02589844 58.92589844 -12 57.625 C-11.98646484 56.35076172 -11.97292969 55.07652344 -11.95898438 53.76367188 C-11.92358199 50.61285943 -11.8741979 47.46288955 -11.8125 44.3125 C-12.76125 44.35375 -13.71 44.395 -14.6875 44.4375 C-17.8125 44.3125 -17.8125 44.3125 -19.8125 42.3125 C-20.03687405 39.64621978 -20.14063665 37.08682988 -20.1484375 34.41796875 C-20.1550943 33.6335994 -20.1617511 32.84923004 -20.16860962 32.04109192 C-20.17874415 30.37922513 -20.18342639 28.71731758 -20.18310547 27.05541992 C-20.18746564 24.51998092 -20.22373744 21.98630114 -20.26171875 19.45117188 C-20.2675895 17.83594345 -20.27155717 16.22070675 -20.2734375 14.60546875 C-20.28780853 13.85009323 -20.30217957 13.09471771 -20.31698608 12.31645203 C-20.28496469 8.60126232 -19.93983496 6.5101974 -17.90869141 3.35668945 C-13.06256745 -1.3692127 -6.40030661 0.04773973 0 0 Z M-13.8125 6.3125 C-15.79505127 10.18527996 -16.04869492 13.3939362 -16.0078125 17.70703125 C-16.00136719 18.90908203 -15.99492187 20.11113281 -15.98828125 21.34960938 C-15.97152344 22.59548828 -15.95476563 23.84136719 -15.9375 25.125 C-15.92847656 26.39021484 -15.91945313 27.65542969 -15.91015625 28.95898438 C-15.88662394 32.07701564 -15.85374545 35.19466097 -15.8125 38.3125 C-14.4925 38.3125 -13.1725 38.3125 -11.8125 38.3125 C-11.4825 30.3925 -11.1525 22.4725 -10.8125 14.3125 C-10.1525 14.3125 -9.4925 14.3125 -8.8125 14.3125 C-8.80219254 14.97204681 -8.79188507 15.63159363 -8.78126526 16.31112671 C-8.67334621 23.1564149 -8.55873661 30.00156754 -8.44018555 36.84667969 C-8.39678978 39.40361707 -8.3551182 41.96058431 -8.31518555 44.51757812 C-8.25759531 48.18628959 -8.19386862 51.85485011 -8.12890625 55.5234375 C-8.11219376 56.67242523 -8.09548126 57.82141296 -8.07826233 59.00521851 C-8.05831711 60.0661673 -8.03837189 61.12711609 -8.01782227 62.22021484 C-8.00227798 63.15731293 -7.9867337 64.09441101 -7.97071838 65.05990601 C-7.95470015 67.34763791 -7.95470015 67.34763791 -6.8125 69.3125 C-5.4925 69.3125 -4.1725 69.3125 -2.8125 69.3125 C-1.44410637 66.57571275 -1.59615182 64.26985576 -1.49609375 61.2109375 C-1.45419922 59.99921875 -1.41230469 58.7875 -1.36914062 57.5390625 C-1.32982422 56.26804688 -1.29050781 54.99703125 -1.25 53.6875 C-1.20681641 52.40875 -1.16363281 51.13 -1.11914062 49.8125 C-1.01280114 46.64594652 -0.91077167 43.47931247 -0.8125 40.3125 C-0.1525 40.3125 0.5075 40.3125 1.1875 40.3125 C1.21255615 41.11993652 1.2376123 41.92737305 1.26342773 42.75927734 C1.37915487 46.40218917 1.50198635 50.04482726 1.625 53.6875 C1.66431641 54.95851562 1.70363281 56.22953125 1.74414062 57.5390625 C1.78603516 58.75078125 1.82792969 59.9625 1.87109375 61.2109375 C1.90775146 62.33161621 1.94440918 63.45229492 1.98217773 64.60693359 C2.01346013 67.27962771 2.01346013 67.27962771 3.1875 69.3125 C4.5075 69.3125 5.8275 69.3125 7.1875 69.3125 C8.45122044 66.78505912 8.30772795 65.04869692 8.30102539 62.22021484 C8.30091209 60.62879166 8.30091209 60.62879166 8.30079651 59.00521851 C8.29305458 57.28173691 8.29305458 57.28173691 8.28515625 55.5234375 C8.28303383 53.76309677 8.28303383 53.76309677 8.28086853 51.9671936 C8.27525689 48.20727015 8.26270238 44.44740555 8.25 40.6875 C8.2449865 38.14323002 8.24042333 35.59895912 8.23632812 33.0546875 C8.22528368 26.80727147 8.20853418 20.55988994 8.1875 14.3125 C9.5075 14.3125 10.8275 14.3125 12.1875 14.3125 C12.1875 22.2325 12.1875 30.1525 12.1875 38.3125 C13.5075 38.3125 14.8275 38.3125 16.1875 38.3125 C16.24565112 33.91672239 16.28114767 29.52104402 16.3125 25.125 C16.32925781 23.87912109 16.34601562 22.63324219 16.36328125 21.34960938 C16.36972656 20.14755859 16.37617187 18.94550781 16.3828125 17.70703125 C16.39328613 16.60206299 16.40375977 15.49709473 16.41455078 14.35864258 C16.18206262 11.23955147 15.60818683 9.08771574 14.1875 6.3125 C9.91214051 3.62420577 5.07483962 4.01489604 0.1875 4.0625 C-0.6065625 4.05476563 -1.400625 4.04703125 -2.21875 4.0390625 C-8.28724608 4.03437312 -8.28724608 4.03437312 -13.8125 6.3125 Z"
							fill="currentColor"
							transform="translate(19.8125,25.6875)"
						/>
						<path
							d="M0 0 C3.12578143 1.6720747 5.39281175 3.7856235 7 7 C7.51512617 11.09157355 7.94367269 15.23589546 5.953125 18.95703125 C3.55501226 21.85592636 1.60351712 23.79811835 -2.171875 24.2734375 C-9.98876369 24.58137554 -9.98876369 24.58137554 -13.5625 21.625 C-17.3057723 17.59378368 -17.39037018 14.90519941 -17.359375 9.55078125 C-16.78039966 5.44131496 -15.00085071 3.78650423 -12 1 C-8.27533151 -0.86233425 -4.05504687 -0.57130829 0 0 Z M-10.375 6.625 C-12.48706506 9.71186432 -12.61195145 11.3282913 -12 15 C-10.5 17.5 -10.5 17.5 -8 19 C-4.3282913 19.61195145 -2.71186432 19.48706506 0.375 17.375 C2.48706506 14.28813568 2.61195145 12.6717087 2 9 C0.5 6.5 0.5 6.5 -2 5 C-5.6717087 4.38804855 -7.28813568 4.51293494 -10.375 6.625 Z"
							fill="currentColor"
							transform="translate(79,0)"
						/>
						<path
							d="M0 0 C3.12578143 1.6720747 5.39281175 3.7856235 7 7 C7.51512617 11.09157355 7.94367269 15.23589546 5.953125 18.95703125 C3.55501226 21.85592636 1.60351712 23.79811835 -2.171875 24.2734375 C-9.98876369 24.58137554 -9.98876369 24.58137554 -13.5625 21.625 C-17.3057723 17.59378368 -17.39037018 14.90519941 -17.359375 9.55078125 C-16.78039966 5.44131496 -15.00085071 3.78650423 -12 1 C-8.27533151 -0.86233425 -4.05504687 -0.57130829 0 0 Z M-10.375 6.625 C-12.48706506 9.71186432 -12.61195145 11.3282913 -12 15 C-10.5 17.5 -10.5 17.5 -8 19 C-4.3282913 19.61195145 -2.71186432 19.48706506 0.375 17.375 C2.48706506 14.28813568 2.61195145 12.6717087 2 9 C0.5 6.5 0.5 6.5 -2 5 C-5.6717087 4.38804855 -7.28813568 4.51293494 -10.375 6.625 Z"
							fill="currentColor"
							transform="translate(25,0)"
						/>
					</svg>
				</div>
				<div>
					<h1 class="text-2xl font-semibold text-white md:text-3xl">Поиск туалетов</h1>
					<p class="-mt-2 text-xl text-slate-200">в Г корпусе</p>
				</div>
			</div>
			<p class="mb-2 text-sm text-slate-400">
				Укажите аудиторию рядом с которой находитесь и найдем ближайший
			</p>

			<ToiletSearchForm bind:audience bind:gender {isLoading} />

			{#if searchResult}
				<ToiletResult result={searchResult} />
			{/if}
		</section>
	</main>

	<Footer />
</PageLayout>

<NotificationsContainer />
